---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import HeroAnimado from "../../components/HeroAnimado.tsx";
import InvitationPrincipal from "../../components/InvitationPrincipal.tsx";
import Contador from "../../components/Contador.tsx";
import Ubicacion from "../../components/Ubicacion.tsx";
import Padrinos from "../../components/Padrinos.tsx";
import DressCode from "../../components/DressCode.tsx";
import MesaDeRegalos from "../../components/MesaDeRegalos.tsx";
import Galeria from "../../components/Galeria.tsx";
import ConfirmarAsistencia from "../../components/ConfirmarAsistencia.tsx";
import { supabaseAnonClient } from "../../utils/supabaseServer";

// --- Lógica del Servidor (SSR) con DEBUGGING ---
const { token } = Astro.params;
let invitado = null;

// Imprimimos en la consola del servidor (donde corres `npm run dev`) para depurar.
console.log("\n--- INICIANDO BÚSQUEDA DE INVITADO ---");
console.log(`[DEBUG] Token recibido de la URL: ${token}`);

if (token) {
    const { data, error } = await supabaseAnonClient
        .from("invitados")
        .select('nombre_invitado_principal, num_acompanantes_permitidos, token_secreto, mesas(nombre_mesa), confirmado, num_asistentes_confirmados')
        .eq("token_secreto", token)
        .single();

    if (error && error.code !== "PGRST116") {
        console.error(`[ERROR] Ocurrió un error al consultar Supabase: ${error.message}`);
    }

    invitado = data;
}

// Si después de la búsqueda no se encontró un invitado, redirigimos a la página de error.
console.log('[DEBUG] Valor de "invitado" antes de la comprobación de redirección:', invitado);
if (!invitado) {
    console.log('[DEBUG] ¡ATENCIÓN! Entrando al bloque IF para redirigir. El invitado es nulo.');
    return Astro.redirect('/error/invalid-invitation');
}
console.log('[DEBUG] El invitado fue encontrado. Se procede a renderizar la página.');
---
---

{/* El título de la página puede ser dinámico si se encontró un invitado */}
<Layout
    title={`Invitación para ${invitado ? invitado.nombre_invitado_principal : "mis XV años"}`}
>
    <main>
        {/* --- PORTADA (Pantallas completas) --- */}
        <HeroAnimado client:load />
        <section id="contenido">
            <InvitationPrincipal client:visible />
        </section>

        {/* --- INFORMACIÓN (Flujo Único) --- */}
        <section class="bg-brand-light py-16">
            <div class="flex flex-col gap-12">
                <Contador client:visible />
                <Ubicacion client:visible />
                <Padrinos client:visible />
                <DressCode client:visible />
                <MesaDeRegalos client:visible />
            </div>
        </section>

        {/* --- GALERÍA (Nueva Experiencia Full-Screen) --- */}
        <section>
            <Galeria client:load />
        </section>

        {/* --- CONFIRMACIÓN DE ASISTENCIA --- */}
        <section class="bg-brand-light py-16">
            <ConfirmarAsistencia client:visible invitado={invitado} />
        </section>
    </main>
</Layout>
