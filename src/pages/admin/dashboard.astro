---
import Layout from "../../layouts/Layout.astro";
import {
  supabaseAnonClient,
  supabaseServiceClient,
} from "../../utils/supabaseServer";

interface InvitadoMesa {
  id: string;
  nombre_invitado_principal: string;
  num_asistentes_confirmados: number;
  confirmado: boolean;
  // Add other properties of an invitado if needed
}

interface MesaConInvitados {
  id: string;
  nombre_mesa: string;
  capacidad: number;
  invitados: InvitadoMesa[];
  // Add other properties of a mesa if needed
}

// Server-side logic for authentication and data fetching
const {
  data: { session },
} = await supabaseAnonClient.auth.getSession();

if (!session) {
  return Astro.redirect("/admin/login");
}

// Fetch all guests if authenticated, and join with the mesas table
const { data: invitados, error: invitadosError } = await supabaseServiceClient
  .from("invitados")
  .select("*, sobrenombre, mesas(nombre_mesa)")
  .order("nombre_invitado_principal", { ascending: true });

if (invitadosError) {
  console.error("Error fetching invitados:", invitadosError.message);
  // Handle error appropriately
}

// Fetch all mesas with their guests
const { data: mesasRaw, error: mesasError } = await supabaseServiceClient
  .from("mesas")
  .select("*, invitados(*, confirmado)");

if (mesasError) {
  console.error("Error fetching mesas:", mesasError.message);
  // Handle error appropriately
}

const mesas: MesaConInvitados[] = (mesasRaw as MesaConInvitados[]) || [];

const mesasConteo = mesas
  ? mesas.map((mesa) => {
      const confirmados = mesa.invitados.reduce(
        (acc: number, invitado: InvitadoMesa) =>
          acc + (invitado.num_asistentes_confirmados || 0),
        0,
      );
      return {
        ...mesa,
        confirmados,
        disponibles: mesa.capacidad - confirmados,
        isFull: confirmados >= mesa.capacidad,
      };
    })
  : [];
---

<Layout title="Panel de Administraci√≥n">
  <main class="min-h-screen bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
        <form method="POST" action="/api/auth/logout">
          <button
            type="submit"
            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            Cerrar Sesi√≥n
          </button>
        </form>
      </div>

      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button
            id="tab-invitados"
            class="whitespace-nowrap py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600"
          >
            Invitados
          </button>
          <button
            id="tab-mesas"
            class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
          >
            Mesas
          </button>
        </nav>
      </div>

      <div id="panel-invitados" class="py-6">
        <div class="mb-4">
          <input
            type="text"
            id="searchInput"
            placeholder="Buscar por nombre del invitado principal..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          />
        </div>

        {
          invitados && invitados.length > 0 ? (
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Invitado Principal
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Sobrenombre
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Estado Confirmaci√≥n
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Pases Permitidos
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Asistentes Confirmados
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Mesa Asignada
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Token
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody
                  class="bg-white divide-y divide-gray-200"
                  id="guest-table-body"
                >
                  {invitados.map((invitado) => (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {invitado.nombre_invitado_principal}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {invitado.sobrenombre || ""}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {invitado.confirmado ? "‚úÖ Confirmado" : "‚ùå Pendiente"}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        {invitado.num_acompanantes_permitidos}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        {invitado.num_asistentes_confirmados}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {invitado.mesas ? invitado.mesas.nombre_mesa : "N/A"}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        {invitado.token_secreto}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-4">
                          <button
                            class="copy-link-btn text-indigo-600 hover:text-indigo-900"
                            data-guest-name={invitado.nombre_invitado_principal}
                            data-token={invitado.token_secreto}
                          >
                            Copiar Enlace
                          </button>
                          <button
                            class="copy-reminder-btn text-green-600 hover:text-green-900"
                            data-guest-name={invitado.nombre_invitado_principal}
                            data-token={invitado.token_secreto}
                          >
                            Copiar Recordatorio
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <p class="text-center text-gray-600">
              No hay invitados registrados.
            </p>
          )
        }
      </div>

      <div id="panel-mesas" class="hidden py-6">
        <div class="mb-4 flex flex-wrap justify-center gap-2 sm:space-x-4">
          <button
            data-filter="all"
            class="mesa-filter-btn bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm"
          >
            Todas
          </button>
          <button
            data-filter="full"
            class="mesa-filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm"
          >
            Completadas
          </button>
          <button
            data-filter="available"
            class="mesa-filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm"
          >
            Incompletas
          </button>
        </div>

        <div
          id="mesas-grid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          {
            mesasConteo.map((mesa) => (
              <div
                class="mesa-card bg-white p-6 rounded-lg shadow-md border"
                data-status={mesa.isFull ? "full" : "available"}
              >
                <h3 class="text-xl font-bold mb-2">{mesa.nombre_mesa}</h3>
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2 sm:gap-0">
                  <div class="text-center sm:text-left">
                    <p class="text-sm text-gray-600">Capacidad</p>
                    <p class="text-lg font-semibold">{mesa.capacidad}</p>
                  </div>
                  <div class="text-center sm:text-left">
                    <p class="text-sm text-gray-600">Confirmados</p>
                    <p class="text-lg font-semibold">{mesa.confirmados}</p>
                  </div>
                  <div class="text-center sm:text-left">
                    <p class="text-sm text-gray-600">Disponibles</p>
                    <p class="text-lg font-semibold">{mesa.disponibles}</p>
                  </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                  <h4 class="font-semibold mb-2">Invitados en esta mesa:</h4>
                  <ul class="list-disc list-inside text-sm pl-2">
                    {mesa.invitados.length > 0 ? (
                      mesa.invitados.map((invitado) => (
                        <li
                          class={
                            invitado.confirmado &&
                            invitado.num_asistentes_confirmados === 0
                              ? "text-red-500 line-through"
                              : ""
                          }
                        >
                          {invitado.nombre_invitado_principal} (
                          {invitado.num_asistentes_confirmados})
                        </li>
                      ))
                    ) : (
                      <li>No hay invitados asignados a esta mesa.</li>
                    )}
                  </ul>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabInvitados = document.getElementById("tab-invitados");
    const tabMesas = document.getElementById("tab-mesas");
    const panelInvitados = document.getElementById("panel-invitados");
    const panelMesas = document.getElementById("panel-mesas");

    if (tabInvitados && tabMesas && panelInvitados && panelMesas) {
      tabInvitados.addEventListener("click", () => {
        panelInvitados.classList.remove("hidden");
        panelMesas.classList.add("hidden");
        tabInvitados.classList.add("border-indigo-500", "text-indigo-600");
        tabInvitados.classList.remove(
          "border-transparent",
          "text-gray-500",
          "hover:text-gray-700",
          "hover:border-gray-300",
        );
        tabMesas.classList.add(
          "border-transparent",
          "text-gray-500",
          "hover:text-gray-700",
          "hover:border-gray-300",
        );
        tabMesas.classList.remove("border-indigo-500", "text-indigo-600");
      });

      tabMesas.addEventListener("click", () => {
        panelMesas.classList.remove("hidden");
        panelInvitados.classList.add("hidden");
        tabMesas.classList.add("border-indigo-500", "text-indigo-600");
        tabMesas.classList.remove(
          "border-transparent",
          "text-gray-500",
          "hover:text-gray-700",
          "hover:border-gray-300",
        );
        tabInvitados.classList.add(
          "border-transparent",
          "text-gray-500",
          "hover:text-gray-700",
          "hover:border-gray-300",
        );
        tabInvitados.classList.remove("border-indigo-500", "text-indigo-600");
      });
    }

    const searchInput = document.getElementById("searchInput");
    const tableBody = document.getElementById("guest-table-body");
    const rows = tableBody ? tableBody.getElementsByTagName("tr") : [];

    if (searchInput) {
      const normalizeString = (str: string) => {
        return str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      };

      searchInput.addEventListener("keyup", () => {
        const searchTerm = normalizeString(
          (searchInput as HTMLInputElement).value,
        );

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const guestNameCell = row.getElementsByTagName("td")[0];
          if (guestNameCell) {
            const guestName =
              guestNameCell.textContent || guestNameCell.innerText;
            if (normalizeString(guestName).includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          }
        }
      });
    }

    if (tableBody) {
      tableBody.addEventListener("click", async (event) => {
        const target = event.target as HTMLElement;
        if (!target.dataset.guestName || !target.dataset.token) return;

        const button = target as HTMLButtonElement;
        const guestName = button.dataset.guestName;
        const token = button.dataset.token;
        const baseUrl = window.location.origin;
        const invitationLink = `${baseUrl}/confirmacion/${token}`;

        if (target.classList.contains("copy-link-btn")) {
          const message = `Con el coraz√≥n lleno de gratitud a Dios, la familia de Yeri Paola desea compartir contigo la alegr√≠a de celebrar sus XV a√±os. ‚ú® Ser√° un honor contar con tu compa√±√≠a en este d√≠a tan importante. Consulta la invitaci√≥n interactiva en el siguiente enlace:
üëâ ${invitationLink}

Por favor confirma tu asistencia antes del 5 de Diciembre.

Para: ${guestName}
Con afecto: Familia M√©ndez Cruz.`;

          try {
            await navigator.clipboard.writeText(message);
            const originalText = button.textContent;
            button.textContent = "¬°Copiado!";
            button.disabled = true;
            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
            }, 2000);
          } catch (err) {
            console.error("Error al copiar el enlace:", err);
            alert("No se pudo copiar el enlace.");
          }
        } else if (target.classList.contains("copy-reminder-btn")) {
          const videoLink = `${baseUrl}/videos/VID_RECORDATORIO.mp4`;
          const message = `¬°Hola, ${guestName}! ‚ú® 
La fecha l√≠mite para confirmar la asistencia a los XV a√±os de Yeri Paola se acerca, y tu presencia es muy importante para nosotros.

Queremos asegurarnos de que el proceso sea sencillo. Si necesitas ayuda para confirmar en la invitaci√≥n digital, aqu√≠ tienes un breve video explicativo:

‚ñ∂Ô∏è: ${videoLink}

Por favor, no olvides confirmar tu asistencia antes del 8 de Diciembre usando el enlace: ${invitationLink}`;

          try {
            await navigator.clipboard.writeText(message);
            const originalText = button.textContent;
            button.textContent = "¬°Recordatorio Copiado!";
            button.disabled = true;
            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
            }, 2000);
          } catch (err) {
            console.error("Error al copiar el recordatorio:", err);
            alert("No se pudo copiar el recordatorio.");
          }
        }
      });
    }

    const filterButtons = document.querySelectorAll(".mesa-filter-btn");
    const mesaCards = document.querySelectorAll(".mesa-card");

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const filter = button.getAttribute("data-filter");

        // Update button styles
        filterButtons.forEach((btn) => {
          btn.classList.remove("bg-indigo-500", "text-white");
          btn.classList.add("bg-gray-200", "text-gray-700");
        });
        button.classList.add("bg-indigo-500", "text-white");
        button.classList.remove("bg-gray-200", "text-gray-700");

        // Filter cards
        mesaCards.forEach((card) => {
          const status = card.getAttribute("data-status");
          if (filter === "all" || filter === status) {
            (card as HTMLElement).style.display = "";
          } else {
            (card as HTMLElement).style.display = "none";
          }
        });
      });
    });
  });
</script>

) : (
<p class="text-center text-gray-600"></p>
)

