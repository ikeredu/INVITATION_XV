---
import Layout from "../../layouts/Layout.astro";
import {
  supabaseAnonClient,
  supabaseServiceClient,
} from "../../utils/supabaseServer";

// Server-side logic for authentication and data fetching
const {
  data: { session },
} = await supabaseAnonClient.auth.getSession();

if (!session) {
  return Astro.redirect("/admin/login");
}

// Fetch all guests if authenticated, and join with the mesas table
const { data: invitados, error } = await supabaseServiceClient
  .from("invitados")
  .select("*, sobrenombre, mesas(nombre_mesa)");

if (error) {
  console.error("Error fetching invitados:", error.message);
  // Handle error appropriately, maybe redirect to an error page or show a message
}

const { data: mesas, error: mesasError } = await supabaseServiceClient
  .from('mesas')
  .select(`
    *,
    invitados (
      *
    )
  `);

if (mesasError) {
  console.error("Error fetching mesas:", mesasError.message);
  // Handle error appropriately, maybe redirect to an error page or show a message
}
---

<Layout title="Panel de Administraci√≥n">
  <main class="min-h-screen bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
        <form method="POST" action="/api/auth/logout">
          <button
            type="submit"
            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            Cerrar Sesi√≥n
          </button>
        </form>
      </div>

      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Buscar por nombre del invitado principal..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg"
        />
      </div>

      {
        invitados && invitados.length > 0 ? (
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Invitado Principal
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Sobrenombre
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Estado Confirmaci√≥n
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Pases Permitidos
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Asistentes Confirmados
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Mesa Asignada
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Token
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody
                class="bg-white divide-y divide-gray-200"
                id="guest-table-body"
              >
                {invitados.map((invitado) => (
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {invitado.nombre_invitado_principal}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {invitado.sobrenombre || ""}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {invitado.confirmado ? "‚úÖ Confirmado" : "‚ùå Pendiente"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                      {invitado.num_acompanantes_permitidos}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                      {invitado.num_asistentes_confirmados}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {invitado.mesas ? invitado.mesas.nombre_mesa : "N/A"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                      {invitado.token_secreto}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <button
                        class="copy-link-btn text-indigo-600 hover:text-indigo-900"
                        data-guest-name={invitado.nombre_invitado_principal}
                        data-token={invitado.token_secreto}
                      >
                        Copiar Enlace
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <p class="text-center text-gray-600">No hay invitados registrados.</p>
        )
      }

      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Vista de Mesas</h2>
        <div id="mesas-container" class="space-y-4">
          {mesas && mesas.map(mesa => {
            const ocupados = mesa.invitados.reduce((acc, inv) => acc + inv.num_asistentes_confirmados, 0);
            let estado = '';
            let color = '';

            if (ocupados < mesa.capacidad) {
              estado = 'Incompleta';
              color = 'text-yellow-600';
            } else if (ocupados === mesa.capacidad) {
              estado = 'Completa';
              color = 'text-green-600';
            } else {
              estado = 'Error de asignaciones';
              color = 'text-red-600';
            }

            return (
              <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="grid grid-cols-4 gap-4 items-center cursor-pointer" data-mesa-id={mesa.id}>
                  <div class="font-semibold">{mesa.nombre_mesa}</div>
                  <div>Capacidad: {mesa.capacidad}</div>
                  <div>Ocupados: {ocupados}</div>
                  <div class={`${color} font-medium`}>{estado}</div>
                </div>
                <div id={`invitados-mesa-${mesa.id}`} class="hidden mt-4 pl-4 border-l-2 border-gray-200">
                  {mesa.invitados.length > 0 ? (
                    <ul class="list-disc ml-5">
                      {mesa.invitados.map(invitado => (
                        <li>{invitado.nombre_invitado_principal} ({invitado.num_asistentes_confirmados} asistentes)</li>
                      ))}
                    </ul>
                  ) : (
                    <p class="text-gray-500">No hay invitados asignados a esta mesa.</p>
                  )}
                </div>
              </div>
            )
          })}
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    const tableBody = document.getElementById("guest-table-body");
    const rows = tableBody ? tableBody.getElementsByTagName("tr") : [];

    if (searchInput) {
      searchInput.addEventListener("keyup", () => {
        const searchTerm = (searchInput as HTMLInputElement).value
          .toLowerCase()
          .trim();

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const guestNameCell = row.getElementsByTagName("td")[0];
          if (guestNameCell) {
            const guestName = guestNameCell.textContent || guestNameCell.innerText;
            if (guestName.toLowerCase().includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          }
        }
      });
    }

    if (tableBody) {
      tableBody.addEventListener("click", async (event) => {
        const target = event.target as HTMLElement;
        if (target.classList.contains("copy-link-btn")) {
          const button = target as HTMLButtonElement;
          const guestName = button.dataset.guestName;
          const token = button.dataset.token;

          if (!guestName || !token) return;

          const baseUrl = window.location.origin;
          const invitationLink = `${baseUrl}/confirmacion/${token}`;

          const message = `Con el coraz√≥n lleno de gratitud a Dios, la familia de Yeri Paola desea compartir contigo la alegr√≠a de celebrar sus XV a√±os. ‚ú® Ser√° un honor contar con tu compa√±√≠a en este d√≠a tan importante. Consulta la invitaci√≥n interactiva en el siguiente enlace:
üëâ ${invitationLink}

Por favor confirma tu asistencia antes del 16 de noviembre.

Para: ${guestName}
Con afecto: Familia M√©ndez Cruz.`;

          try {
            await navigator.clipboard.writeText(message);
            const originalText = button.textContent;
            button.textContent = "¬°Copiado!";
            button.disabled = true;
            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
            }, 2000);
          } catch (err) {
            console.error("Error al copiar el enlace:", err);
            alert("No se pudo copiar el enlace.");
          }
        }
      });
    }

    const mesasContainer = document.getElementById("mesas-container");
    if (mesasContainer) {
      mesasContainer.addEventListener("click", (event) => {
        const target = event.target as HTMLElement;
        const mesaHeader = target.closest("[data-mesa-id]");
        if (mesaHeader) {
          const mesaId = mesaHeader.getAttribute("data-mesa-id");
          const invitadosList = document.getElementById(`invitados-mesa-${mesaId}`);
          if (invitadosList) {
            invitadosList.classList.toggle("hidden");
          }
        }
      });
    }
  });
</script>

) : (
<p class="text-center text-gray-600"></p>
)

